(function($){$.fn.justifiedGallery=function(options){var settings=$.extend({'sizeRangeSuffixes':{'lt100':'_t','lt240':'_m','lt320':'_n','lt500':'','lt640':'_z','lt1024':'_b'},'rowHeight':120,'margins':1,'justifyLastRow':true,'fixedHeight':false,'captions':true,'rel':null,'target':null,'extension':/\.[^.]+$/,'refreshTime':500,'onComplete':null},options);function getErrorHtml(message,classOfError){return"<div class=\"jg-error "+classOfError+"\"style=\"\">"+message+"</div>"}return this.each(function(index,cont){$(cont).addClass("justifiedGallery");var loaded=0;var images=new Array($(cont).find("img").length);if(images.length==0)return;$(cont).append("<div class=\"jg-loading\"><div class=\"jg-loading-img\"></div></div>");$(cont).find("a").each(function(index,entry){var imgEntry=$(entry).find("img");images[index]=new Array(5);images[index]["src"]=(typeof $(imgEntry).data("safe-src")!='undefined')?$(imgEntry).data("safe-src"):$(imgEntry).attr("src");images[index]["alt"]=$(imgEntry).attr("alt");images[index]["href"]=$(entry).attr("href");images[index]["title"]=$(entry).attr("title");images[index]["rel"]=(settings.rel!=null)?settings.rel:$(entry).attr("rel");images[index]["target"]=(settings.target!=null)?settings.target:$(entry).attr("target");images[index]["extension"]=images[index]["src"].match(settings.extension)[0];$(entry).remove();var img=new Image();$(img).load(function(){if(images[index]["height"]!=settings.rowHeight)images[index]["width"]=Math.ceil(this.width/(this.height/settings.rowHeight));else images[index]["width"]=this.width;images[index]["height"]=settings.rowHeight;var usedSizeRangeRegExp=new RegExp("("+settings.sizeRangeSuffixes.lt100+"|"+settings.sizeRangeSuffixes.lt240+"|"+settings.sizeRangeSuffixes.lt320+"|"+settings.sizeRangeSuffixes.lt500+"|"+settings.sizeRangeSuffixes.lt640+"|"+settings.sizeRangeSuffixes.lt1024+")$");images[index]["src"]=images[index]["src"].replace(settings.extension,"").replace(usedSizeRangeRegExp,"");if(++loaded==images.length)startProcess(cont,images,settings)});$(img).error(function(){$(cont).prepend(getErrorHtml("The image can't be loaded: \""+images[index]["src"]+"\"","jg-usedPrefixImageNotFound"));images[index]=null;if(++loaded==images.length)startProcess(cont,images,settings)});$(img).attr('src',images[index]["src"])})});function startProcess(cont,images,settings){$(cont).find(".jg-loading").fadeOut(500,function(){$(this).remove();processesImages($,cont,images,0,settings);if($.isFunction(settings.onComplete))settings.onComplete.call(this,cont)})}function buildImage(image,suffix,nw,nh,l,minRowHeight,settings){var ris;ris="<div class=\"jg-image\" style=\"left:"+l+"px\">";ris+=" <a href=\""+image["href"]+"\" ";if(typeof image["rel"]!='undefined')ris+="rel=\""+image["rel"]+"\"";if(typeof image["target"]!='undefined')ris+="target=\""+image["target"]+"\"";ris+="title=\""+image["title"]+"\">";ris+="  <img alt=\""+image["alt"]+"\" src=\""+image["src"]+suffix+image.extension+"\"";ris+="style=\"width: "+nw+"px; height: "+nh+"px;\">";if(settings.captions)ris+="  <div style=\"bottom:"+(nh-minRowHeight)+"px;\" class=\"jg-image-label\">"+image["alt"]+"</div>";ris+=" </a></div>";return ris}function buildContRow(row,images,extraW,settings){var j,l=0;var minRowHeight;for(var j=0;j<row.length;j++){row[j]["nh"]=Math.ceil(images[row[j]["indx"]]["height"]*((images[row[j]["indx"]]["width"]+extraW)/images[row[j]["indx"]]["width"]));row[j]["nw"]=images[row[j]["indx"]]["width"]+extraW;row[j]["suffix"]=getSuffix(row[j]["nw"],row[j]["nh"],settings);row[j]["l"]=l;if(!settings.fixedHeight){if(j==0)minRowHeight=row[j]["nh"];else if(minRowHeight>row[j]["nh"])minRowHeight=row[j]["nh"]}l+=row[j]["nw"]+settings.margins}if(settings.fixedHeight)minRowHeight=settings.rowHeight;var rowCont="";for(var j=0;j<row.length;j++){rowCont+=buildImage(images[row[j]["indx"]],row[j]["suffix"],row[j]["nw"],row[j]["nh"],row[j]["l"],minRowHeight,settings)}return"<div class=\"jg-row\" style=\"height: "+minRowHeight+"px; margin-bottom:"+settings.margins+"px;\">"+rowCont+"</div>"}function getSuffix(nw,nh,settings){var n;if(nw>nh)n=nw;else n=nh;if(n<=100){return settings.sizeRangeSuffixes.lt100}else if(n<=240){return settings.sizeRangeSuffixes.lt240}else if(n<=320){return settings.sizeRangeSuffixes.lt320}else if(n<=500){return settings.sizeRangeSuffixes.lt500}else if(n<=640){return settings.sizeRangeSuffixes.lt640}else{return settings.sizeRangeSuffixes.lt1024}}function processesImages($,cont,images,lastRowWidth,settings){var row=new Array();var row_i,i;var partialRowWidth=0;var extraW;var rowWidth=$(cont).width();for(i=0,row_i=0;i<images.length;i++){if(images[i]==null)continue;if(partialRowWidth+images[i]["width"]+settings.margins<=rowWidth){partialRowWidth+=images[i]["width"]+settings.margins;row[row_i]=new Array(5);row[row_i]["indx"]=i;row_i++}else{extraW=Math.ceil((rowWidth-partialRowWidth+1)/row.length);$(cont).append(buildContRow(row,images,extraW,settings));row=new Array();row[0]=new Array(5);row[0]["indx"]=i;row_i=1;partialRowWidth=images[i]["width"]+settings.margins}}if(settings.justifyLastRow){extraW=Math.ceil((rowWidth-partialRowWidth+1)/row.length)}else{extraW=0}$(cont).append(buildContRow(row,images,extraW,settings));if(settings.captions){$(cont).find(".jg-image").mouseenter(function(sender){$(sender.currentTarget).find(".jg-image-label").stop();$(sender.currentTarget).find(".jg-image-label").fadeTo(500,0.7)});$(cont).find(".jg-image").mouseleave(function(sender){$(sender.currentTarget).find(".jg-image-label").stop();$(sender.currentTarget).find(".jg-image-label").fadeTo(500,0)})}$(cont).find(".jg-resizedImageNotFound").remove();$(cont).find(".jg-image img").load(function(){$(this).fadeTo(500,1)}).error(function(){$(cont).prepend(getErrorHtml("The image can't be loaded: \""+$(this).attr("src")+"\"","jg-resizedImageNotFound"))}).each(function(){if(this.complete)$(this).load()})}function checkWidth($,cont,images,lastRowWidth,settings){var id=setInterval(function(){if(lastRowWidth!=$(cont).width()){$(cont).find(".jg-row").remove();clearInterval(id);processesImages($,cont,images,lastRowWidth,settings);return}},settings.refreshTime)}}})(jQuery);