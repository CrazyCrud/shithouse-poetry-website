(function(e){e.fn.justifiedGallery=function(t){function r(e,t){return'<div class="jg-error '+t+'"style="">'+e+"</div>"}function i(t,n,r){a(e,t,n,0,r);if(e.isFunction(r.onComplete))r.onComplete.call(this,t)}function s(e,t,n,r,i,s,o){var u;u='<div class="jg-image" style="left:'+i+'px">';u+=' <a href="'+e["href"]+'" ';if(typeof e["rel"]!="undefined")u+='rel="'+e["rel"]+'"';if(typeof e["target"]!="undefined")u+='target="'+e["target"]+'"';u+='title="'+e["title"]+'">';u+='  <img alt="'+e["alt"]+'" src="'+e["src"]+t+e.extension+'"';u+='style="width: '+n+"px; height: "+r+'px;">';if(o.captions)u+='  <div style="bottom:'+(r-s)+'px;" class="jg-image-label">'+e["alt"]+"</div>";u+=" </a></div>";return u}function o(e,t,n,r){var i,o=0;var a;for(var i=0;i<e.length;i++){e[i]["nh"]=Math.ceil(t[e[i]["indx"]]["height"]*((t[e[i]["indx"]]["width"]+n)/t[e[i]["indx"]]["width"]));e[i]["nw"]=t[e[i]["indx"]]["width"]+n;e[i]["suffix"]=u(e[i]["nw"],e[i]["nh"],r);e[i]["l"]=o;if(!r.fixedHeight){if(i==0)a=e[i]["nh"];else if(a>e[i]["nh"])a=e[i]["nh"]}o+=e[i]["nw"]+r.margins}if(r.fixedHeight)a=r.rowHeight;var f="";for(var i=0;i<e.length;i++){f+=s(t[e[i]["indx"]],e[i]["suffix"],e[i]["nw"],e[i]["nh"],e[i]["l"],a,r)}return'<div class="jg-row" style="height: '+a+"px; margin-bottom:"+r.margins+'px;">'+f+"</div>"}function u(e,t,n){var r;if(e>t)r=e;else r=t;if(r<=100){return n.sizeRangeSuffixes.lt100}else if(r<=240){return n.sizeRangeSuffixes.lt240}else if(r<=320){return n.sizeRangeSuffixes.lt320}else if(r<=500){return n.sizeRangeSuffixes.lt500}else if(r<=640){return n.sizeRangeSuffixes.lt640}else{return n.sizeRangeSuffixes.lt1024}}function a(e,t,n,i,s){var u=new Array;var a,f;var l=0;var c;var h=e(t).width();for(f=0,a=0;f<n.length;f++){if(n[f]==null)continue;if(l+n[f]["width"]+s.margins<=h){l+=n[f]["width"]+s.margins;u[a]=new Array(5);u[a]["indx"]=f;a++}else{c=Math.ceil((h-l+1)/u.length);e(t).append(o(u,n,c,s));u=new Array;u[0]=new Array(5);u[0]["indx"]=f;a=1;l=n[f]["width"]+s.margins}}if(s.justifyLastRow){c=Math.ceil((h-l+1)/u.length)}else{c=0}e(t).append(o(u,n,c,s));if(s.captions){e(t).find(".jg-image").mouseenter(function(t){e(t.currentTarget).find(".jg-image-label").stop();e(t.currentTarget).find(".jg-image-label").fadeTo(500,.7)});e(t).find(".jg-image").mouseleave(function(t){e(t.currentTarget).find(".jg-image-label").stop();e(t.currentTarget).find(".jg-image-label").fadeTo(500,0)})}e(t).find(".jg-resizedImageNotFound").remove();e(t).find(".jg-image img").load(function(){e(this).fadeTo(500,1)}).error(function(){e(t).prepend(r("The image can't be loaded: \""+e(this).attr("src")+'"',"jg-resizedImageNotFound"))}).each(function(){if(this.complete)e(this).load()})}function f(e,t,n,r,i){var s=setInterval(function(){if(r!=e(t).width()){e(t).find(".jg-row").remove();clearInterval(s);a(e,t,n,r,i);return}},i.refreshTime)}var n=e.extend({sizeRangeSuffixes:{lt100:"_t",lt240:"_m",lt320:"_n",lt500:"",lt640:"_z",lt1024:"_b"},rowHeight:120,margins:1,justifyLastRow:true,fixedHeight:false,captions:true,rel:null,target:null,extension:/\.[^.]+$/,refreshTime:500,onComplete:null},t);return this.each(function(t,s){e(s).addClass("justifiedGallery");var o=0;var u=new Array(e(s).find("img").length);if(u.length==0)return;e(s).find("a").each(function(t,a){var f=e(a).find("img");u[t]=new Array(5);u[t]["src"]=typeof e(f).data("safe-src")!="undefined"?e(f).data("safe-src"):e(f).attr("src");u[t]["alt"]=e(f).attr("alt");u[t]["href"]=e(a).attr("href");u[t]["title"]=e(a).attr("title");u[t]["rel"]=n.rel!=null?n.rel:e(a).attr("rel");u[t]["target"]=n.target!=null?n.target:e(a).attr("target");u[t]["extension"]=u[t]["src"].match(n.extension)[0];e(a).remove();var l=new Image;e(l).load(function(){if(u[t]["height"]!=n.rowHeight)u[t]["width"]=Math.ceil(this.width/(this.height/n.rowHeight));else u[t]["width"]=this.width;u[t]["height"]=n.rowHeight;var e=new RegExp("("+n.sizeRangeSuffixes.lt100+"|"+n.sizeRangeSuffixes.lt240+"|"+n.sizeRangeSuffixes.lt320+"|"+n.sizeRangeSuffixes.lt500+"|"+n.sizeRangeSuffixes.lt640+"|"+n.sizeRangeSuffixes.lt1024+")$");u[t]["src"]=u[t]["src"].replace(n.extension,"").replace(e,"");if(++o==u.length)i(s,u,n)});e(l).error(function(){e(s).prepend(r("The image can't be loaded: \""+u[t]["src"]+'"',"jg-usedPrefixImageNotFound"));u[t]=null;if(++o==u.length)i(s,u,n)});e(l).attr("src",u[t]["src"])})})}})(jQuery);